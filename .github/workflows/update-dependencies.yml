name: Update Dependencies
on:
  workflow_dispatch:
  schedule:
    - cron: 0 21 * * 5
  workflow_call:
    secrets:
      PAT_GITHUB:
        required: true

permissions:
  contents: write
  pull-requests: write

jobs:
  update-dependencies:
    runs-on: ubuntu-latest
    env:
      HUSKY: 0

    steps:
      - name: Checkout the repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          persist-credentials: false

      - name: Use PNPM
        uses: pnpm/action-setup@41ff72655975bd51cab0327fa583b6e92b6d3061 # v4.2.0
        with:
          run_install: false

      - name: Use Node.js
        uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f # v6.1.0
        with:
          node-version: 22
          cache: "pnpm"

      - name: Setup Terraform
        if: ${{ hashFiles('**/*.tf') != '' }}
        uses: hashicorp/setup-terraform@b9cd54a3c349d3f38e8881555d616ced269862dd # v3.1.2
        with:
          terraform_version: 1.14.3

      - name: Enable Corepack
        run: |
          corepack enable
          corepack --version

      - name: Setup GitHub user
        run: |
          git config --global user.name "AlexUpBot"
          git config --global user.email "alexupbot@bot.com"

      - name: Install dependencies
        run: pnpm install

      - name: Install actions-up and alex-c-line
        run: |
          npm install -g actions-up@latest alex-c-line@latest
          actions-up --version
          alex-c-line --version

      - name: Update pull request templates
        run: alex-c-line create-pull-request-templates

      - name: Commit template changes
        uses: AlexMan123456/github-actions/.github/actions/commit-changes@78be199abfba7efedbc8a151b98a58963038cad7 # v4.0.4
        id: commit_pull_request_template_changes
        with:
          message: "Update pull request templates"

      - name: Update PNPM
        run: corepack use pnpm@latest

      - name: Commit PNPM update
        uses: AlexMan123456/github-actions/.github/actions/commit-changes@78be199abfba7efedbc8a151b98a58963038cad7 # v4.0.4
        id: commit_pnpm_update
        with:
          message: "Update PNPM"

      - name: Update JavaScript dependencies
        run: |
          pnpm run update-dependencies
          pnpm install --no-frozen-lockfile

      - name: Commit JavaScript dependencies updates
        uses: AlexMan123456/github-actions/.github/actions/commit-changes@78be199abfba7efedbc8a151b98a58963038cad7 # v4.0.4
        id: commit_javascript_dependencies_updates
        with:
          message: "Update JavaScript dependencies"

      - name: Update GitHub Actions
        run: actions-up -y

      - name: Commit GitHub Actions updates
        uses: AlexMan123456/github-actions/.github/actions/commit-changes@78be199abfba7efedbc8a151b98a58963038cad7 # v4.0.4
        id: commit_actions_updates
        with:
          message: "Update GitHub Actions"

      - name: Update Terraform Providers
        if: ${{ hashFiles('**/*.tf') != '' }}
        run: terraform init -upgrade -backend=false

      - name: Commit Terraform updates
        if: ${{ hashFiles('**/*.tf') != '' }}
        uses: AlexMan123456/github-actions/.github/actions/commit-changes@78be199abfba7efedbc8a151b98a58963038cad7 # v4.0.4
        id: commit_terraform_updates
        with:
          message: "Update Terraform Providers"

      - name: Choose pull request template
        id: pull_request_template
        env:
          TEMPLATES_CHANGED: ${{ steps.commit_pull_request_template_changes.outputs.changes_detected }}
          PNPM_CHANGED: ${{ steps.commit_pnpm_update.outputs.changes_detected }}
          JS_CHANGED: ${{ steps.commit_javascript_dependencies_updates.outputs.changes_detected }}
          ACTIONS_CHANGED: ${{ steps.commit_actions_updates.outputs.changes_detected }}
          TERRAFORM_CHANGED: ${{ steps.commit_terraform_updates.outputs.changes_detected }}
        run: |
          if [ "$TEMPLATES_CHANGED" = "true" ] && \
            [ "$PNPM_CHANGED" = "false" ] && \
            [ "$JS_CHANGED" = "false" ] && \
            [ "$ACTIONS_CHANGED" = "false" ] && \
            [ "$TERRAFORM_CHANGED" = "false" ]; then
            echo "Template: documentation_change"
            echo "body_path=.github/PULL_REQUEST_TEMPLATE/documentation_change.md" >> "$GITHUB_OUTPUT"
          else
            echo "Template: tooling_change"
            echo "body_path=.github/PULL_REQUEST_TEMPLATE/tooling_change.md" >> "$GITHUB_OUTPUT"
          fi

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@98357b18bf14b5342f975ff684046ec3b2a07725 # v8.0.0
        with:
          token: ${{ secrets.PAT_GITHUB }}
          author: AlexUpBot <alexupbot@bot.com>
          committer: AlexUpBot <alexupbot@bot.com>
          branch: alex-up-bot/update-dependencies
          base: main
          title: "Update dependencies"
          body-path: ${{ steps.pull_request_template.outputs.body_path }}
